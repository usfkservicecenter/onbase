<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>OnBase USAG Humphreys Í±¥Î¨º ÏßÄÎèÑ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .building-label {
      color: #6b7280; font-size: 10px; font-weight: 700;
      text-shadow: 1px 1px 2px #fff; white-space: nowrap; pointer-events: none;
    }
    /* locate Î≤ÑÌäº Í∞ÑÎã® Ïä§ÌÉÄÏùº */
    .leaflet-control-locate {
      background: #fff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    .leaflet-control-locate button {
      width: 34px; height: 34px; line-height: 34px; text-align: center;
      border: none; background: transparent; cursor: pointer; font-size: 18px;
    }
    .leaflet-control-locate button:active { transform: scale(0.97); }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    // ===== Í≤åÏù¥Ìä∏ Ï¢åÌëú =====
    const gates = [
      { name: "Millet Gate (ÎèÑÎëêÎ¶¨)",  lat: 36.95819961, lon: 127.04428911 },
      { name: "Yoon Gate (Ïú§)",        lat: 36.96894099, lon: 127.03556648 },
      { name: "Charlton Gate (Ìï®Ï†ïÎ¶¨)", lat: 36.95159,    lon: 127.0198 }
    ];

    // ===== ÏÑú/Î∂Å ÎÅùÎã® ÌôïÏû• Ìè¨Ïù∏Ìä∏ =====
    const westMostLon  = 126.9846803;   // 5901 (Driving Range)
    const northMostLat = 36.9824546;    // 8710

    // ===== bounds Í≥ÑÏÇ∞ (ÎÇ®Ï™Ω Ïó¨Ïú†, ÏÑú/Î∂Å ÌôïÏû• Î∞òÏòÅ) =====
    const lats = gates.map(g => g.lat);
    const lons = gates.map(g => g.lon);
    const minLatRaw = Math.min(...lats);
    const maxLatRaw = Math.max(northMostLat, ...lats);
    const minLonRaw = Math.min(westMostLon, ...lons);
    const maxLonRaw = Math.max(...lons);

    const padN = 0.004;  // Î∂ÅÏ™Ω Ïó¨Ïú†
    const padS = 0.010;  // ÎÇ®Ï™Ω Ïó¨Ïú†
    const padW = 0.003;  // ÏÑúÏ™Ω Ïó¨Ïú†
    const padE = 0.003;  // ÎèôÏ™Ω Ïó¨Ïú†

    const gateBounds = L.latLngBounds(
      [minLatRaw - padS, minLonRaw - padW],
      [maxLatRaw + padN, maxLonRaw + padE]
    );

    // ===== ÏßÄÎèÑ (ÎùºÏù¥Ìä∏ ÌÉÄÏùº + Î∂ÄÎìúÎü¨Ïö¥ Í≤ΩÍ≥Ñ) =====
    const map = L.map('map', {
      zoomControl: true,
      scrollWheelZoom: true,
      touchZoom: true,
      dragging: true,
      doubleClickZoom: true,
      maxBounds: gateBounds,
      maxBoundsViscosity: 0.95
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CARTO',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    map.fitBounds(gateBounds);

    // (ÏòµÏÖò) Í≤åÏù¥Ìä∏ ÏúÑÏπò ÌëúÏãú
    gates.forEach(g => {
      L.circleMarker([g.lat, g.lon], { radius: 4 }).addTo(map).bindTooltip(g.name);
    });

    // ===== ÎùºÎ≤® ÌëúÏãú Ï†úÏñ¥ =====
    const buildingMarkers = [];
    const LABEL_ZOOM = 15; // 15Î∂ÄÌÑ∞ ÌëúÏãú

    function updateBuildingLabels() {
      const zoom = map.getZoom();
      buildingMarkers.forEach(m => {
        const onMap = map.hasLayer(m);
        if (zoom >= LABEL_ZOOM && !onMap) m.addTo(map);
        if (zoom <  LABEL_ZOOM && onMap)  map.removeLayer(m);
      });
    }
    map.on('zoomend', updateBuildingLabels);

    // ===== Ï¢åÌëú Î°úÎìú: addr:housenumber Ïö∞ÏÑ† ÌëúÏãú =====
    fetch('./buildings.json')
      .then(res => res.json())
      .then(buildings => {
        buildings.forEach(b => {
          const lat = b.lat ?? b.y;
          const lon = b.lon ?? b.x;
          if (lat == null || lon == null) return;

          const labelText =
            (b["addr:housenumber"] && String(b["addr:housenumber"]).trim()) ||
            (b.name && String(b.name).trim()) || "";
          if (!labelText) return;

          const marker = L.marker([lat, lon], {
            icon: L.divIcon({
              className: 'building-label',
              html: labelText,
              iconSize: [26, 12],
              iconAnchor: [13, 6]
            })
          });
          buildingMarkers.push(marker);
        });
        updateBuildingLabels();
      })
      .catch(err => console.error('Í±¥Î¨º Ï¢åÌëú Î°úÎìú Ïã§Ìå®:', err));

    // ===== ÎÇ¥ ÏúÑÏπò Ï∞æÍ∏∞ Î≤ÑÌäº (Ïª§Ïä§ÌÖÄ Ïª®Ìä∏Î°§) =====
    const userLayer = L.layerGroup().addTo(map);
    let lastLocate = null;

    const LocateControl = L.Control.extend({
      onAdd: function () {
        const container = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar');
        const btn = L.DomUtil.create('button', '', container);
        btn.title = 'ÎÇ¥ ÏúÑÏπò Ï∞æÍ∏∞';
        btn.innerHTML = 'üìç';
        // ÏßÄÎèÑ Ï†úÏä§Ï≤òÏôÄ Ï∂©Îèå Î∞©ÏßÄ
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(btn, 'click', (e) => {
          e.preventDefault();
          // Ìïú Î≤à ÌÅ¥Î¶≠ Ïãú ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥Îèô
          map.locate({
            setView: true,
            maxZoom: 18,
            enableHighAccuracy: true,
            watch: false
          });
        });
        return container;
      },
      onRemove: function () {}
    });
    map.addControl(new LocateControl({ position: 'topleft' }));

    map.on('locationfound', (e) => {
      userLayer.clearLayers();
      // ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§ + Ï†ïÌôïÎèÑ Ïõê
      L.circleMarker(e.latlng, { radius: 6 }).addTo(userLayer);
      L.circle(e.latlng, { radius: e.accuracy }).addTo(userLayer);
      lastLocate = e.latlng;
    });

    map.on('locationerror', (e) => {
      alert('ÏúÑÏπò Ï†ëÍ∑º Ïã§Ìå®: ' + e.message + '\n(HTTPS ÎòêÎäî localhostÏóêÏÑú ÌÖåÏä§Ìä∏Ìï¥ Ï£ºÏÑ∏Ïöî)');
    });

    // ÏÇ¨ÌååÎ¶¨ Îì±ÏóêÏÑú ÏûêÎèô ÎπÑÌôúÏÑ±Ìôî ÎåÄÎπÑ
    map.whenReady(() => {
      if (!map.options.scrollWheelZoom) map.scrollWheelZoom.enable();
      if (!map.options.touchZoom) map.touchZoom.enable();
      if (!map.options.dragging) map.dragging.enable();
    });
  </script>
</body>
</html>
